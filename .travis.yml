dist: trusty
filter_secrets: false
sudo: false

env:
  - ES_VERSION=6.6.2 ES_DOWNLOAD_URL=https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-${ES_VERSION}.tar.gz

addons:
  postgresql: 9.6
  apt:
    packages:
      - libxml2-dev
      - libpq-dev
      - openjdk-7-jdk
      - python-dev
      - postgresql-9.6-postgis-2.3

services:
  - postgresql
  - couchdb

before_install:
  - psql -d postgres -c "ALTER USER postgres with encrypted password 'postgis';"
  - echo "*:*:*:postgres:postgis" >> ~/.pgpass
  - psql -d postgres -c "SET standard_conforming_strings = off;"
  - psql -d postgres -c "CREATE EXTENSION postgis;"
  - wget ${ES_DOWNLOAD_URL}
  - tar -xzf elasticsearch-${ES_VERSION}.tar.gz
  - ./elasticsearch-${ES_VERSION}/bin/elasticsearch &

install:
  - npm ci
  - python setup.py install
  - pip install -r arches/install/requirements_dev.txt
  - pip install coveralls
  - npm start -- --silent &

cache:
  - apt
  - pip

after_success:
  - coveralls

before_script:
  - ./arches/install/ci_install/setup_couch.sh

matrix:
  include:
    - language: python
      python: 2.7
      script:
        - curl -v http://localhost:9200/
        - python manage.py test tests --pattern="*.py" --settings="tests.test_settings"
    - language: node_js
      node_js: 10.8
      cache:
        directories:
          - ~/.cache
          - ~/.npm
        override:
          - npm ci
          - npm run cy:verify
      script:
        - ${npm bin}/cypress run --record
